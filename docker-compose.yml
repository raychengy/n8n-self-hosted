# This is the base Docker Compose file for local development.
# It starts the n8n, postgres, and task runner services.
# To run this file, use: docker-compose up -d

services:
  # Service for the PostgreSQL database.
  postgresdb:
    image: postgres:18.1-bookworm
    restart: unless-stopped
    environment:
      # Database credentials and name sourced from the .env file.
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      # Persists database data on the host machine.
      # For postgres:18, the data is stored in the root of the volume.
      - ${N8N_POSTGRES_DATA_PATH:-./pgdata}:/var/lib/postgresql
    healthcheck:
      # Ensures that other services only start after the database is ready.
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Service for the main n8n application.
  n8n:
    image: n8nio/n8n:2.1.0
    restart: unless-stopped
    environment:
      # == Database Configuration ==
      # Tells n8n to use a PostgreSQL database.
      DB_TYPE: postgresdb
      # The following variables connect n8n to the postgresdb service.
      DB_POSTGRESDB_HOST: postgresdb
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${POSTGRES_DB}
      DB_POSTGRESDB_USER: ${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}

      # == Timezone Settings ==
      # Sets the timezone for the n8n application and container.
      GENERIC_TIMEZONE: ${GENERIC_TIMEZONE}
      TZ: ${TZ}

      # == Task Runner Configuration ==
      # Enables external runners for executing workflows.
      N8N_RUNNERS_ENABLED: true
      N8N_RUNNERS_MODE: external
      # Listens on all network interfaces inside the container for runner connections.
      N8N_RUNNERS_BROKER_LISTEN_ADDRESS: "0.0.0.0"
      # Shared secret to authenticate runners. Must match the runner's token.
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}

      # == Webhook & Editor URL Configuration ==
      # These variables define how n8n is accessed externally.
      # For local mode, these should point to http://localhost:5678.
      # For tunnel mode, these should point to your public Cloudflare URL.
      N8N_HOST: ${N8N_HOST}
      N8N_PROTOCOL: https
      N8N_EDITOR_BASE_URL: ${N8N_EDITOR_BASE_URL}
      WEBHOOK_URL: ${WEBHOOK_URL}
      # Specifies the number of reverse proxies between the user and n8n.
      # '1' is correct for the Cloudflare Tunnel setup.
      N8N_PROXY_HOPS: ${N8N_PROXY_HOPS:-1}

    ports:
      # Exposes n8n on port 5678 for local access.
      # This is disabled when using the tunnel override file.
      - "5678:5678"
    depends_on:
      # Ensures n8n only starts after the database is healthy.
      postgresdb:
        condition: service_healthy
    volumes:
      # Persists n8n's user data, workflows, and credentials.
      - ${N8N_DATA_PATH:-./n8ndata}:/home/node/.n8n

  # Service for the external task runner.
  n8n-task-runners:
    image: raychengy/n8n-runner:latest
    restart: unless-stopped
    environment:
      # == Runner Connection Settings ==
      # The address of the main n8n instance's broker.
      N8N_RUNNERS_TASK_BROKER_URI: http://n8n:5679
      # Shared secret to authenticate with the main n8n instance.
      N8N_RUNNERS_AUTH_TOKEN: ${N8N_RUNNERS_AUTH_TOKEN}
      N8N_RUNNERS_LAUNCHER_LOG_LEVEL: info
    volumes:
      # Mounts the runner configuration file, which defines the types of runners
      # (e.g., javascript, python) and their allowed packages.
      - ${N8N_RUNNERS_CONFIG_PATH:-./n8n-task-runners.json}:/etc/n8n-task-runners.json
    depends_on:
      # Ensures the runner only starts after the main n8n service has started.
      n8n:
        condition: service_started
